#! /usr/bin/python

"""
NAME
    sub-get - download subtitle for a movie from opensubtitles.org

SYNOPSIS
    sub-get MOVIE-FILE [MOVIE-FILE-CD2 ...]

TODO
    kill cache support
    proxy support
        use polipo for development
    documentation
    license
    upload to github
        ask for review by opensubtitles' folks
    rename to opensub-get ?
    unit test suite
        if __name__ == "__main__": test()
    python2/3 compatibility
    unix/windows portability
    setup.py
    use opensubtitle.org's xmlrpc api?
    multiple languages in preference order?
"""

import argparse
import logging
import os
import sys
import tempfile

sys.path.append(
     os.path.join(
         os.path.dirname(__file__), "..", "lib" ) )

import opensubtitles.main

def setup_logging(verbosity):

    log_level_dict = {
        0: "WARNING",
        1: "INFO",
        2: "DEBUG",
        }

    try:
        log_level = getattr( logging, log_level_dict[verbosity] )
    except KeyError:
        raise Exception(
            "invalid log level: -{}".format( "v" * verbosity ) )

    logging.basicConfig(
        level = log_level,
        format = "%(levelname)s: %(filename)s:%(lineno)d: %(message)s",
        )

    return None

def hardcoded_proxy():

    return "127.0.0.1:8123"

def default_proxy():

    try:
        proxy = os.environ["http_proxy"]
    except KeyError:
        proxy = hardcoded_proxy()
    return proxy

def parse_cli_args():

    """Procedure for command line argument parsing."""

    p = argparse.ArgumentParser()

    # proxy setting preference order:
    #    1. use cli argument if given
    #    2. use environment variable if set
    #    3. use hardcoded default
    p.add_argument(
        "-p", "--http-proxy",
        action = "store",
        default = default_proxy(),
        help = "http_proxy:port, optional, default: {}".format(
            hardcoded_proxy()),
        )

    # FIXME validate language id
    p.add_argument(
        "-l", "--language",
        action = "store",
        default = "eng",
        help = "subtitle language (ISO 639), optional, default: eng",
        )

    p.add_argument(
        "-v", "--verbose",
        action = "count",
        default = 0,
        help = "increase verbosity (-v, -vv), optional",
        )

    p.add_argument("movie_file",
        nargs = "+",
        help = "movie file (or files belonging to the same movie)",
        )

    return p.parse_args()

def main():

    args = parse_cli_args()
    setup_logging( verbosity = args.verbose )

    movie_file_list = args.movie_file
    logging.debug( "movie_file_list: {}".format(movie_file_list) )

    for movie_file in movie_file_list:
        assert os.path.isfile(movie_file), \
            "no such file: {}".format(movie_file)

    subtitle_list = opensubtitles.main.get_subtitle(
        movie_file_list = movie_file_list,
        subtitle_language = args.language,
        http_proxy = args.http_proxy,
        )

    # assumptions:
    #   * the user provided movie_file_list in "natural order"
    #   * subtitle_list is sorted by subtitle.name,
    #     therefore it is in "natural order"
    for movie_file, subtitle in zip( movie_file_list, subtitle_list ):

        assert not movie_file is None
        assert not subtitle is None

        base, _ = os.path.splitext(movie_file)
        _, extension = os.path.splitext(subtitle.name)
        dest = base + extension

        logging.debug(
            "extract_rename: {} -> {}".format(subtitle.name, dest) )

        #with tempfile.NamedTemporaryFile(
        #    mode="wb",
        #    prefix=".tmp-sub-",
        #    delete=False,
        #    dir=os.path.dirname( args.movie_path )) as t:
        #    t.write( subtitle.content )
        #    subtitle_tmp_file = t.name
        #    logging.debug( "subtitle_tmp_file: {}".format(subtitle_tmp_file) )

        ## FIXME os.link is unix-only
        #os.link( subtitle_tmp_file, dest )
        #os.unlink( subtitle_tmp_file )

    # give useful error msg if the move was unsuccessful
    # cleanup

if __name__ == "__main__":
    main()
