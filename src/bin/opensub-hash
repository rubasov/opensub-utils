#! /usr/bin/python

"""
Usage:
    opensub-get [-h|--help] [--version] [--] <video-files>...

Description:
    opensub-hash - Print hash of video files.

    Calculate and print hash of video files as used by opensubtitles.org.
    Output is a hash-filename pair per line.

    Keep in mind that the hash of a multi-file (multi-cd) movie is defined
    as the hash of the first file (cd).

See Also:
    * opensub-get
    * http://www.opensubtitles.org/
    * http://trac.opensubtitles.org/projects/opensubtitles/wiki/HashSourceCodes

Credits:
    Copyright (c) 2013 Bence Romsics <rubasov@gmail.com>
"""

# FIXME better version handling (use git describe)
__version__ = "0.9"

import errno
import os
import sys

import docopt

sys.path.append(
    os.path.join(
        os.path.dirname(
            os.path.realpath(
                __file__)),
        "..",
        "lib"))

import opensub


def main():

    args = docopt.docopt(__doc__, version=__version__)
    ev = 0

    for path in args["<video-files>"]:

        try:

            with open(path, "rb") as f:
                print("{} {}".format(opensub.hash_file(f), path))

        except OSError as e:

            if e.errno == errno.ENOENT:
                sys.stdout.flush()
                sys.stderr.write("no such file: {}\n".format(path))
                ev = 1
                pass
            else:
                raise

    sys.exit(ev)


if __name__ == "__main__":
    main()
